name: Copy Telegram Secrets to Repos

on:
  workflow_dispatch:

jobs:
  copy-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: pip install pynacl requests

      - name: Copy secrets to target repos
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python3 << 'PYEOF'
          import os, json, base64, requests
          from nacl import encoding, public

          GH_TOKEN = os.environ["GH_TOKEN"]
          SECRETS_TO_COPY = {
              "TELEGRAM_BOT_TOKEN": os.environ["TELEGRAM_BOT_TOKEN"],
              "TELEGRAM_CHAT_ID": os.environ["TELEGRAM_CHAT_ID"],
          }
          TARGET_REPOS = [
              "breverdbidder/zonewise-web",
              "breverdbidder/brevard-bidder-scraper",
          ]

          headers = {
              "Authorization": f"Bearer {GH_TOKEN}",
              "Accept": "application/vnd.github.v3+json",
          }

          def encrypt_secret(public_key: str, secret_value: str) -> str:
              pk = public.PublicKey(public_key.encode("utf-8"), encoding.Base64Encoder())
              sealed = public.SealedBox(pk).encrypt(secret_value.encode("utf-8"))
              return base64.b64encode(sealed).decode("utf-8")

          for repo in TARGET_REPOS:
              print(f"\n=== {repo} ===")
              # Get public key
              r = requests.get(f"https://api.github.com/repos/{repo}/actions/secrets/public-key", headers=headers)
              if r.status_code != 200:
                  print(f"  Failed to get public key: {r.status_code}")
                  continue
              pk_data = r.json()
              key_id = pk_data["key_id"]
              pub_key = pk_data["key"]

              for name, value in SECRETS_TO_COPY.items():
                  encrypted = encrypt_secret(pub_key, value)
                  r = requests.put(
                      f"https://api.github.com/repos/{repo}/actions/secrets/{name}",
                      headers=headers,
                      json={"encrypted_value": encrypted, "key_id": key_id}
                  )
                  status = "✅" if r.status_code in [201, 204] else f"❌ {r.status_code}"
                  print(f"  {name}: {status}")

          print("\nDone!")
          PYEOF
