# BidDeed.AI - Plan Enforcement Agent v4.0
# YAML-safe: Python scripts stored as base64 env vars, decoded at runtime
# All PR comment table rows indented inside run blocks to avoid YAML parse conflicts
# PLAN PR -> AI Architect review -> plan-approved label
# CODE PR -> Gate 1 (label) -> Gate 2 (coverage + Claude) -> auto-merge or fix

name: Plan Enforcement Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write
  statuses: write
  issues: write

env:
  SCRIPT_REVIEW_PLAN: "aW1wb3J0IGpzb24sIHN5cywgb3MsIHVybGxpYi5yZXF1ZXN0CmFwaV9rZXkgPSBvcy5lbnZpcm9uWyJBTlRIUk9QSUNfQVBJX0tFWSJdCnBsYW4gPSBvcGVuKCIvdG1wL3BsYW5fY29udGVudC50eHQiKS5yZWFkKCkKcHJfdGl0bGUgPSBvcy5lbnZpcm9uLmdldCgiUFJfVElUTEUiLCAiIikKcHJvbXB0ID0gZiIiIllvdSBhcmUgdGhlIEFJIEFyY2hpdGVjdCBmb3IgQmlkRGVlZC5BSSAoZm9yZWNsb3N1cmUgYXVjdGlvbiBBSSBwbGF0Zm9ybSkuClJldmlldyB0aGlzIFBMQU4ubWQgYW5kIGRlY2lkZSBpZiBDbGF1ZGUgQ29kZSBpcyBjbGVhcmVkIHRvIGltcGxlbWVudC4KUFI6IHtwcl90aXRsZX0KUExBTi5tZDoKe3BsYW59CkNoZWNrIGZvcjogT2JqZWN0aXZlLCBGaWxlcyBDaGFuZ2VkLCBBcHByb2FjaCwgUmlza3MsIE5PVCBEb2luZywgRXN0aW1hdGVkIENvbXBsZXhpdHkuCkZsYWcgaWYgc2NvcGUgdG9vIGJyb2FkLCBjb25mbGljdHMgd2l0aCBMYW5nR3JhcGgvU3VwYWJhc2UvR2l0SHViIEFjdGlvbnMsIG9yIG1pc3NpbmcgZG9tYWluIGNvbnNpZGVyYXRpb25zLgpSZXNwb25kIE9OTFkgd2l0aCB2YWxpZCBKU09OLCBubyBtYXJrZG93bjoKeyJ2ZXJkaWN0IjogIkFQUFJPVkVEIG9yIENIQU5HRVNfUkVRVUVTVEVEIiwgInNjb3JlIjogMCwgInNlY3Rpb25zX3N0YXR1cyI6IHsib2JqZWN0aXZlIjogIlBBU1Mgb3IgRkFJTCIsICJmaWxlc19jaGFuZ2VkIjogIlBBU1Mgb3IgRkFJTCIsICJhcHByb2FjaCI6ICJQQVNTIG9yIEZBSUwiLCAicmlza3MiOiAiUEFTUyBvciBGQUlMIiwgIm5vdF9kb2luZyI6ICJQQVNTIG9yIEZBSUwiLCAiY29tcGxleGl0eSI6ICJQQVNTIG9yIEZBSUwifSwgImlzc3VlcyI6IFtdLCAiaW1wcm92ZW1lbnRzIjogW10sICJhcmNoaXRlY3Rfbm90ZSI6ICIyIHNlbnRlbmNlcyIsICJjbGVhcmVkX2Zvcl9pbXBsZW1lbnRhdGlvbiI6IHRydWV9ClNjb3JlIDg1KyA9IEFQUFJPVkVELiIiIgpwYXlsb2FkID0geyJtb2RlbCI6ICJjbGF1ZGUtc29ubmV0LTQtNSIsICJtYXhfdG9rZW5zIjogMTUwMCwgIm1lc3NhZ2VzIjogW3sicm9sZSI6ICJ1c2VyIiwgImNvbnRlbnQiOiBwcm9tcHR9XX0KcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdCgiaHR0cHM6Ly9hcGkuYW50aHJvcGljLmNvbS92MS9tZXNzYWdlcyIsIGRhdGE9anNvbi5kdW1wcyhwYXlsb2FkKS5lbmNvZGUoKSkKcmVxLmFkZF9oZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIikKcmVxLmFkZF9oZWFkZXIoIngtYXBpLWtleSIsIGFwaV9rZXkpCnJlcS5hZGRfaGVhZGVyKCJhbnRocm9waWMtdmVyc2lvbiIsICIyMDIzLTA2LTAxIikKd2l0aCB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcSkgYXMgcmVzcDoKICAgIGRhdGEgPSBqc29uLmxvYWQocmVzcCkKdGV4dCA9IGRhdGFbImNvbnRlbnQiXVswXVsidGV4dCJdLnN0cmlwKCkKaWYgdGV4dC5zdGFydHN3aXRoKCJgYGAiKToKICAgIHRleHQgPSB0ZXh0LnNwbGl0KCJgYGAiKVsxXQogICAgaWYgdGV4dC5zdGFydHN3aXRoKCJqc29uIik6IHRleHQgPSB0ZXh0WzQ6XQpwcmludCh0ZXh0LnN0cmlwKCkpCg=="
  SCRIPT_GATE2_SCORE: "aW1wb3J0IGpzb24sIHN5cywgb3MsIHVybGxpYi5yZXF1ZXN0CmFwaV9rZXkgPSBvcy5lbnZpcm9uWyJBTlRIUk9QSUNfQVBJX0tFWSJdCnBsYW4gPSBvcGVuKCIvdG1wL2dhdGUyX3BsYW4udHh0IikucmVhZCgpCmRpZmYgPSBvcGVuKCIvdG1wL2dhdGUyX2RpZmYudHh0IikucmVhZCgpCmZpbGVzID0gb3BlbigiL3RtcC9nYXRlMl9maWxlcy50eHQiKS5yZWFkKCkKcHJfdGl0bGUgPSBvcy5lbnZpcm9uLmdldCgiUFJfVElUTEUiLCAiIikKY29tcGxleGl0eSA9IG9zLmVudmlyb24uZ2V0KCJDT01QTEVYSVRZIiwgIk1lZGl1bSIpCmNvdmVyYWdlID0gb3MuZW52aXJvbi5nZXQoIkNPVkVSQUdFIiwgIjAiKQp0ZXN0cyA9IG9zLmVudmlyb24uZ2V0KCJURVNUUyIsICIiKQpwcm9tcHQgPSBmIiIiWW91IGFyZSB0aGUgUGxhbiBFbmZvcmNlbWVudCBBZ2VudCBmb3IgQmlkRGVlZC5BSS4KVmVyaWZ5IGltcGxlbWVudGF0aW9uIG1hdGNoZXMgdGhlIGFwcHJvdmVkIFBMQU4ubWQuIFJlc3BvbmQgT05MWSB3aXRoIHZhbGlkIEpTT04sIG5vIG1hcmtkb3duLgpQUjoge3ByX3RpdGxlfSB8IENvbXBsZXhpdHk6IHtjb21wbGV4aXR5fSB8IENvdmVyYWdlOiB7Y292ZXJhZ2V9JSAobWluIDgwJSkgfCBUZXN0czoge3Rlc3RzfQpQTEFOLm1kOiB7cGxhbn0KQ2hhbmdlZCBGaWxlczoge2ZpbGVzfQpEaWZmOiB7ZGlmZn0KUmV0dXJuOiB7InZlcmRpY3QiOiAiUEFTUyIsICJzY29yZSI6IDk1LCAiZGltZW5zaW9ucyI6IHsic2NvcGVfbWF0Y2giOiB7InNjb3JlIjogOTUsICJzdGF0dXMiOiAiUEFTUyIsICJmaW5kaW5nIjogIm9uZSBzZW50ZW5jZSJ9LCAiZmlsZXNfbWF0Y2giOiB7InNjb3JlIjogOTUsICJzdGF0dXMiOiAiUEFTUyIsICJmaW5kaW5nIjogIm9uZSBzZW50ZW5jZSJ9LCAiYXBwcm9hY2hfbWF0Y2giOiB7InNjb3JlIjogOTUsICJzdGF0dXMiOiAiUEFTUyIsICJmaW5kaW5nIjogIm9uZSBzZW50ZW5jZSJ9LCAibm9fc2NvcGVfY3JlZXAiOiB7InNjb3JlIjogOTUsICJzdGF0dXMiOiAiUEFTUyIsICJmaW5kaW5nIjogIm9uZSBzZW50ZW5jZSJ9fSwgImNyaXRpY2FsX2lzc3VlcyI6IFtdLCAid2FybmluZ3MiOiBbXSwgImZpeF9pbnN0cnVjdGlvbnMiOiBbXSwgInN1bW1hcnkiOiAiMi0zIHNlbnRlbmNlcyIsICJhcmllbF9hY3Rpb24iOiAiQVBQUk9WRSJ9ClNjb3Jpbmc6IFBBU1M+PTkwIEFORCBjb3ZlcmFnZT49ODAuIFdBUk49NzAtODkuIEZBSUw8NzAuIFBlbmFsaXplIGNvdmVyYWdlPDgwLiBGbGFnIFB5dGhvbiBmaWxlcyB3aXRob3V0IHRlc3RzLiIiIgpwYXlsb2FkID0geyJtb2RlbCI6ICJjbGF1ZGUtc29ubmV0LTQtNSIsICJtYXhfdG9rZW5zIjogMjAwMCwgIm1lc3NhZ2VzIjogW3sicm9sZSI6ICJ1c2VyIiwgImNvbnRlbnQiOiBwcm9tcHR9XX0KcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdCgiaHR0cHM6Ly9hcGkuYW50aHJvcGljLmNvbS92MS9tZXNzYWdlcyIsIGRhdGE9anNvbi5kdW1wcyhwYXlsb2FkKS5lbmNvZGUoKSkKcmVxLmFkZF9oZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIikKcmVxLmFkZF9oZWFkZXIoIngtYXBpLWtleSIsIGFwaV9rZXkpCnJlcS5hZGRfaGVhZGVyKCJhbnRocm9waWMtdmVyc2lvbiIsICIyMDIzLTA2LTAxIikKd2l0aCB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcSkgYXMgcmVzcDoKICAgIGRhdGEgPSBqc29uLmxvYWQocmVzcCkKdGV4dCA9IGRhdGFbImNvbnRlbnQiXVswXVsidGV4dCJdLnN0cmlwKCkKaWYgdGV4dC5zdGFydHN3aXRoKCJgYGAiKToKICAgIHRleHQgPSB0ZXh0LnNwbGl0KCJgYGAiKVsxXQogICAgaWYgdGV4dC5zdGFydHN3aXRoKCJqc29uIik6IHRleHQgPSB0ZXh0WzQ6XQpwcmludCh0ZXh0LnN0cmlwKCkpCg=="
  SCRIPT_GEN_TESTS: "aW1wb3J0IGpzb24sIHN5cywgb3MsIHVybGxpYi5yZXF1ZXN0CmFwaV9rZXkgPSBvcy5lbnZpcm9uWyJBTlRIUk9QSUNfQVBJX0tFWSJdCnBsYW4gPSBvcGVuKCIvdG1wL2Nvdl9wbGFuLnR4dCIpLnJlYWQoKQpmaWxlcyA9IG9wZW4oIi90bXAvY292X2ZpbGVzLnR4dCIpLnJlYWQoKQpjb3ZlcmFnZSA9IG9zLmVudmlyb24uZ2V0KCJDT1ZFUkFHRSIsICIwIikKcHJvbXB0ID0gZiIiIkNvdmVyYWdlIGlzIHtjb3ZlcmFnZX0lIChtaW5pbXVtIDgwJSkuIFdyaXRlIHRlc3QgaW5zdHJ1Y3Rpb25zIGZvciBDbGF1ZGUgQ29kZS4KRmlsZXMgbmVlZGluZyB0ZXN0czoge2ZpbGVzfQpQbGFuOiB7cGxhbn0KUmVzcG9uZCBPTkxZIHdpdGggdmFsaWQgSlNPTjogeyJmaWxlc19uZWVkaW5nX3Rlc3RzIjogWyJmaWxlLnB5Il0sICJ0ZXN0X2luc3RydWN0aW9ucyI6IFt7ImZpbGUiOiAidGVzdHMvdGVzdF9YLnB5IiwgInRlc3RzX3RvX3dyaXRlIjogWyJ0ZXN0IG5hbWVzIl0sICJwcmlvcml0eSI6ICJISUdIIn1dLCAiY2xhdWRlX2NvZGVfaW5zdHJ1Y3Rpb24iOiAiRXhlY3V0ZSB0aGUgZm9sbG93aW5nIHRvIHJlYWNoIDgwJSBjb3ZlcmFnZS4uLiIsICJlc3RpbWF0ZWRfdGltZSI6ICJYIG1pbnV0ZXMifSIiIgpwYXlsb2FkID0geyJtb2RlbCI6ICJjbGF1ZGUtc29ubmV0LTQtNSIsICJtYXhfdG9rZW5zIjogMTUwMCwgIm1lc3NhZ2VzIjogW3sicm9sZSI6ICJ1c2VyIiwgImNvbnRlbnQiOiBwcm9tcHR9XX0KcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdCgiaHR0cHM6Ly9hcGkuYW50aHJvcGljLmNvbS92MS9tZXNzYWdlcyIsIGRhdGE9anNvbi5kdW1wcyhwYXlsb2FkKS5lbmNvZGUoKSkKcmVxLmFkZF9oZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIikKcmVxLmFkZF9oZWFkZXIoIngtYXBpLWtleSIsIGFwaV9rZXkpCnJlcS5hZGRfaGVhZGVyKCJhbnRocm9waWMtdmVyc2lvbiIsICIyMDIzLTA2LTAxIikKd2l0aCB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcSkgYXMgcmVzcDoKICAgIGRhdGEgPSBqc29uLmxvYWQocmVzcCkKdGV4dCA9IGRhdGFbImNvbnRlbnQiXVswXVsidGV4dCJdLnN0cmlwKCkKaWYgdGV4dC5zdGFydHN3aXRoKCJgYGAiKToKICAgIHRleHQgPSB0ZXh0LnNwbGl0KCJgYGAiKVsxXQogICAgaWYgdGV4dC5zdGFydHN3aXRoKCJqc29uIik6IHRleHQgPSB0ZXh0WzQ6XQpwcmludCh0ZXh0LnN0cmlwKCkpCg=="
  SCRIPT_GEN_FIXES: "aW1wb3J0IGpzb24sIHN5cywgb3MsIHVybGxpYi5yZXF1ZXN0CmFwaV9rZXkgPSBvcy5lbnZpcm9uWyJBTlRIUk9QSUNfQVBJX0tFWSJdCnJldmlldyA9IG9wZW4oIi90bXAvd2Fybl9yZXZpZXcudHh0IikucmVhZCgpCnByX3RpdGxlID0gb3MuZW52aXJvbi5nZXQoIlBSX1RJVExFIiwgIiIpCnNjb3JlID0gb3MuZW52aXJvbi5nZXQoIlNDT1JFIiwgIjAiKQpwcm9tcHQgPSBmIiIiQUkgQXJjaGl0ZWN0IGZvciBCaWREZWVkLkFJLiBHYXRlIDIgV0FSTiAoe3Njb3JlfS8xMDApIGZvcjoge3ByX3RpdGxlfQpSZXZpZXc6IHtyZXZpZXd9CldyaXRlIHByZWNpc2UgZml4IGluc3RydWN0aW9ucyBmb3IgQ2xhdWRlIENvZGUuIFJlc3BvbmQgT05MWSB3aXRoIHZhbGlkIEpTT046CnsicHJpb3JpdHlfZml4ZXMiOiBbeyJpc3N1ZSI6ICJ3aGF0IGlzIHdyb25nIiwgImZpbGUiOiAicGF0aC5weSIsICJmaXgiOiAiZXhhY3RseSB3aGF0IHRvIGRvIiwgInVyZ2VuY3kiOiAiSElHSCJ9XSwgImNsYXVkZV9jb2RlX2luc3RydWN0aW9uIjogIkV4ZWN1dGUgdGhlIGZvbGxvd2luZyBmaXhlcy4uLiIsICJlc3RpbWF0ZWRfZml4X3RpbWUiOiAiWCBtaW51dGVzIiwgImV4cGVjdGVkX3Njb3JlX2FmdGVyX2ZpeCI6IDkyfSIiIgpwYXlsb2FkID0geyJtb2RlbCI6ICJjbGF1ZGUtc29ubmV0LTQtNSIsICJtYXhfdG9rZW5zIjogMTUwMCwgIm1lc3NhZ2VzIjogW3sicm9sZSI6ICJ1c2VyIiwgImNvbnRlbnQiOiBwcm9tcHR9XX0KcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdCgiaHR0cHM6Ly9hcGkuYW50aHJvcGljLmNvbS92MS9tZXNzYWdlcyIsIGRhdGE9anNvbi5kdW1wcyhwYXlsb2FkKS5lbmNvZGUoKSkKcmVxLmFkZF9oZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi9qc29uIikKcmVxLmFkZF9oZWFkZXIoIngtYXBpLWtleSIsIGFwaV9rZXkpCnJlcS5hZGRfaGVhZGVyKCJhbnRocm9waWMtdmVyc2lvbiIsICIyMDIzLTA2LTAxIikKd2l0aCB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcSkgYXMgcmVzcDoKICAgIGRhdGEgPSBqc29uLmxvYWQocmVzcCkKdGV4dCA9IGRhdGFbImNvbnRlbnQiXVswXVsidGV4dCJdLnN0cmlwKCkKaWYgdGV4dC5zdGFydHN3aXRoKCJgYGAiKToKICAgIHRleHQgPSB0ZXh0LnNwbGl0KCJgYGAiKVsxXQogICAgaWYgdGV4dC5zdGFydHN3aXRoKCJqc29uIik6IHRleHQgPSB0ZXh0WzQ6XQpwcmludCh0ZXh0LnN0cmlwKCkpCg=="
  SCRIPT_SECTIONS_PARSE: "aW1wb3J0IGpzb24sc3lzLG9zCmQ9anNvbi5sb2FkKHN5cy5zdGRpbikKcz1kLmdldCgnc2VjdGlvbnNfc3RhdHVzJyx7fSkKbGFiZWxzPXsnb2JqZWN0aXZlJzonT2JqZWN0aXZlJywnZmlsZXNfY2hhbmdlZCc6J0ZpbGVzIENoYW5nZWQnLCdhcHByb2FjaCc6J0FwcHJvYWNoJywncmlza3MnOidSaXNrcycsJ25vdF9kb2luZyc6J05PVCBEb2luZycsJ2NvbXBsZXhpdHknOidDb21wbGV4aXR5J30Kb3V0PSIiCmZvciBrLGxhYmVsIGluIGxhYmVscy5pdGVtcygpOgogICAgc3Q9cy5nZXQoaywnPycpCiAgICBvdXQrPWYifCB7bGFiZWx9IHwge3N0fSB8CiIKcHJpbnQob3V0KQo="
  SCRIPT_ISSUES_PARSE: "aW1wb3J0IGpzb24sc3lzCmQ9anNvbi5sb2FkKHN5cy5zdGRpbikKb3V0PSIiCmZvciBpIGluIGQuZ2V0KCdpc3N1ZXMnLFtdKTogb3V0Kz1mIi0ge2l9CiIKZm9yIGkgaW4gZC5nZXQoJ2ltcHJvdmVtZW50cycsW10pOiBvdXQrPWYiLSB7aX0KIgpwcmludChvdXQpCg=="
  SCRIPT_DIMS_PARSE: "aW1wb3J0IGpzb24sc3lzLG9zCmQ9anNvbi5sb2FkKHN5cy5zdGRpbikKa2V5PW9zLmVudmlyb24uZ2V0KCJESU1fS0VZIiwic2NvcGVfbWF0Y2giKQpzPWQuZ2V0KCdkaW1lbnNpb25zJyx7fSkuZ2V0KGtleSx7fSkKcHJpbnQocy5nZXQoJ3N0YXR1cycsJz8nKSsnIC0gJytzLmdldCgnZmluZGluZycsJycpKQo="
  SCRIPT_FIXES_FMT: "aW1wb3J0IGpzb24sc3lzCmQ9anNvbi5sb2FkKHN5cy5zdGRpbikKb3V0PSIiCmZvciBpLGYgaW4gZW51bWVyYXRlKGQuZ2V0KCdwcmlvcml0eV9maXhlcycsW10pLDEpOgogICAgb3V0Kz1mIkZpeCB7aX0gW3tmLmdldCgndXJnZW5jeScsJ01FRElVTScpfV06IHtmLmdldCgnaXNzdWUnLCcnKX0gfCB7Zi5nZXQoJ2ZpbGUnLCcnKX0gfCB7Zi5nZXQoJ2ZpeCcsJycpfQoiCnByaW50KG91dCkK"
  SCRIPT_GATE2_COMMENT: "aW1wb3J0IG9zCmQgPSB7azogb3MuZW52aXJvbi5nZXQoaywnJykgZm9yIGsgaW4gWydWRVJESUNUJywnU0NPUkUnLCdMQUJFTCcsJ1NDT1BFJywnRklMRVNfRElNJywnQVBQUk9BQ0gnLCdDUkVFUCcsJ0NPVl9ST1cnLCdURVNUUycsJ1NVTU1BUlknXX0KYm9keSA9ICIiIiMjIEdhdGUgMiAtIHtMQUJFTH0gKHtTQ09SRX0vMTAwKQoKfCBEaW1lbnNpb24gfCBSZXN1bHQgfAp8LS0tLS0tLS0tLS18LS0tLS0tLS18CnwgU2NvcGUgbWF0Y2ggfCB7U0NPUEV9IHwKfCBGaWxlcyBtYXRjaCB8IHtGSUxFU19ESU19IHwKfCBBcHByb2FjaCBtYXRjaCB8IHtBUFBST0FDSH0gfAp8IE5vIHNjb3BlIGNyZWVwIHwge0NSRUVQfSB8CnwgVGVzdCBjb3ZlcmFnZSB8IHtDT1ZfUk9XfSB8CnwgVGVzdHMgfCB7VEVTVFN9IHwKCioqU3VtbWFyeToqKiB7U1VNTUFSWX0KCi0tLQoqUGxhbiBFbmZvcmNlbWVudCBBZ2VudCB2NC4wIC0gY2xhdWRlLXNvbm5ldC00LTUgLSBCaWREZWVkLkFJKiIiIi5mb3JtYXQoKipkKQpvcGVuKCcvdG1wL2NvbW1lbnQudHh0JywndycpLndyaXRlKGJvZHkpCg=="

jobs:

  architect-plan-review:
    runs-on: ubuntu-latest
    name: "AI Architect - Plan Review"
    outputs:
      is_plan_only: ${{ steps.detect.outputs.is_plan_only }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect plan-only PR
        id: detect
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD 2>/dev/null || echo "")
          HAS_PLAN=$(echo "$CHANGED" | grep -qE "^PLAN\.md$" && echo "true" || echo "false")
          CODE=$(echo "$CHANGED" | grep -vE "PLAN\.md|\.md$|docs/|README|CHANGELOG|LICENSE" || true)
          HAS_CODE=$([ -n "$CODE" ] && echo "true" || echo "false")
          if [ "$HAS_PLAN" = "true" ] && [ "$HAS_CODE" = "false" ]; then
            echo "is_plan_only=true" >> $GITHUB_OUTPUT
          else
            echo "is_plan_only=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Architect - Evaluate PLAN.md
        if: steps.detect.outputs.is_plan_only == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          cat PLAN.md | head -c 6000 > /tmp/plan_content.txt
          echo "$SCRIPT_REVIEW_PLAN" | base64 -d > /tmp/review_plan.py
          echo "$SCRIPT_SECTIONS_PARSE" | base64 -d > /tmp/sections_parse.py
          echo "$SCRIPT_ISSUES_PARSE" | base64 -d > /tmp/issues_parse.py
          REVIEW_JSON=$(python3 /tmp/review_plan.py 2>/dev/null || echo '{"verdict":"CHANGES_REQUESTED","score":0,"architect_note":"API error - check ANTHROPIC_API_KEY","sections_status":{},"issues":["API error"],"improvements":[]}')
          VERDICT=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('verdict','CHANGES_REQUESTED'))" 2>/dev/null || echo "CHANGES_REQUESTED")
          SCORE=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('score',0))" 2>/dev/null || echo "0")
          NOTE=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('architect_note',''))" 2>/dev/null || echo "")
          SECTIONS=$(echo "$REVIEW_JSON" | python3 /tmp/sections_parse.py 2>/dev/null || echo "")
          ISSUES=$(echo "$REVIEW_JSON" | python3 /tmp/issues_parse.py 2>/dev/null || echo "")
          if [ "$VERDICT" = "APPROVED" ]; then
            gh pr edit $PR_NUMBER --add-label "plan-approved" 2>/dev/null || \
              curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
                -d '{"labels":["plan-approved"]}' > /dev/null
            BODY=$(printf '## AI Architect - PLAN APPROVED (%s/100)\n\n' "$SCORE")
            BODY+=$(printf '| Section | Status |\n|---------|--------|\n%s\n' "$SECTIONS")
            BODY+=$(printf '**Architect note:** %s\n\nClaude Code - cleared to implement. Open a new PR with implementation.\n\n---\n*AI Architect (claude-sonnet-4-5) - Plan Enforcement Agent v4.0 - BidDeed.AI*' "$NOTE")
            gh pr comment $PR_NUMBER --body "$BODY"
          else
            BODY=$(printf '## AI Architect - CHANGES REQUESTED (%s/100)\n\n' "$SCORE")
            BODY+=$(printf '| Section | Status |\n|---------|--------|\n%s\n\n' "$SECTIONS")
            BODY+=$(printf '**Architect note:** %s\n\n%s\n\nFix issues above, push updated PLAN.md. Auto-reviewed on push.\n\n---\n*AI Architect - Plan Enforcement Agent v4.0 - BidDeed.AI*' "$NOTE" "$ISSUES")
            gh pr comment $PR_NUMBER --body "$BODY"
          fi

  gate1-plan-required:
    needs: architect-plan-review
    if: needs.architect-plan-review.outputs.is_plan_only == 'false'
    runs-on: ubuntu-latest
    name: "Gate 1 - Architect-Approved Plan Required"
    outputs:
      has_plan: ${{ steps.detect.outputs.has_plan }}
      has_code: ${{ steps.detect.outputs.has_code }}
      plan_approved: ${{ steps.detect.outputs.plan_approved }}
      complexity: ${{ steps.detect.outputs.complexity }}
      changed_files: ${{ steps.detect.outputs.changed_files }}
      plan_content: ${{ steps.detect.outputs.plan_content }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check plan and approval
        id: detect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD 2>/dev/null || echo "")
          if [ -f "PLAN.md" ]; then
            COMPLEXITY=$(grep -iE "complexity.*(Low|Medium|High)" PLAN.md | grep -oiE "Low|Medium|High" | head -1 || echo "Medium")
            echo "has_plan=true" >> $GITHUB_OUTPUT
            echo "complexity=$COMPLEXITY" >> $GITHUB_OUTPUT
            echo "plan_content<<PLAN_EOF" >> $GITHUB_OUTPUT
            cat PLAN.md | head -c 8000 >> $GITHUB_OUTPUT
            echo "PLAN_EOF" >> $GITHUB_OUTPUT
          else
            echo "has_plan=false" >> $GITHUB_OUTPUT
            echo "complexity=unknown" >> $GITHUB_OUTPUT
            echo "plan_content=" >> $GITHUB_OUTPUT
          fi
          LABELS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            | python3 -c "import json,sys; print(' '.join([l['name'] for l in json.load(sys.stdin)]))" 2>/dev/null || echo "")
          APPROVED_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&per_page=20" \
            | python3 -c "import json,sys; prs=json.load(sys.stdin); print('found' if any('plan-approved' in [l['name'] for l in p.get('labels',[])] for p in prs) else 'none')" 2>/dev/null || echo "none")
          if echo "$LABELS" | grep -q "plan-approved" || [ "$APPROVED_EXISTS" = "found" ]; then
            echo "plan_approved=true" >> $GITHUB_OUTPUT
          else
            echo "plan_approved=false" >> $GITHUB_OUTPUT
          fi
          CODE=$(echo "$CHANGED" | grep -vE "PLAN\.md|\.md$|docs/|README|CHANGELOG|LICENSE" || true)
          if [ -n "$CODE" ]; then
            echo "has_code=true" >> $GITHUB_OUTPUT
            echo "changed_files<<FILES_EOF" >> $GITHUB_OUTPUT
            echo "$CODE" | head -20 >> $GITHUB_OUTPUT
            echo "FILES_EOF" >> $GITHUB_OUTPUT
          else
            echo "has_code=false" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
          fi

      - name: BLOCKED - No approved plan
        if: steps.detect.outputs.has_code == 'true' && (steps.detect.outputs.has_plan == 'false' || steps.detect.outputs.plan_approved == 'false')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "BLOCKED - No Architect-Approved Plan. Submit a PLAN.md PR first. AI Architect auto-reviews (no human needed). Once plan-approved label applied, open implementation PR. PLAN.md requires: Objective, Files Changed, Approach, Risks, NOT Doing, Estimated Complexity. -- Plan Enforcement Agent v4.0 - BidDeed.AI"
          exit 1

  gate2-plan-verification:
    needs: gate1-plan-required
    if: |
      needs.gate1-plan-required.outputs.has_plan == 'true' &&
      needs.gate1-plan-required.outputs.has_code == 'true' &&
      needs.gate1-plan-required.outputs.plan_approved == 'true'
    runs-on: ubuntu-latest
    name: "Gate 2 - Plan Verification + Coverage"
    outputs:
      verdict: ${{ steps.score.outputs.verdict }}
      score: ${{ steps.score.outputs.score }}
      review_json: ${{ steps.score.outputs.review_json }}
      summary: ${{ steps.score.outputs.summary }}
      critical_issues: ${{ steps.score.outputs.critical_issues }}
      coverage_pct: ${{ steps.coverage.outputs.coverage_pct }}
      scope: ${{ steps.score.outputs.scope }}
      files_dim: ${{ steps.score.outputs.files_dim }}
      approach: ${{ steps.score.outputs.approach }}
      creep: ${{ steps.score.outputs.creep }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run test coverage
        id: coverage
        run: |
          CHANGED_PY=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep "\.py$" | grep -v "test_" | head -10 || echo "")
          if [ -n "$CHANGED_PY" ]; then
            pip install pytest pytest-cov --quiet 2>/dev/null || true
            pip install -r requirements.txt --quiet 2>/dev/null || true
            COV_OUT=$(python3 -m pytest tests/ --cov=src --cov-report=term-missing --tb=no -q 2>&1 | tail -20 || echo "0 passed")
            COV_PCT=$(echo "$COV_OUT" | grep -oE "TOTAL[[:space:]]+[0-9]+[[:space:]]+[0-9]+[[:space:]]+([0-9]+)%" | grep -oE "[0-9]+%" | tail -1 | tr -d "%" || echo "0")
            TESTS=$(echo "$COV_OUT" | grep -oE "[0-9]+ (passed|failed)" | tr '\n' ' ' || echo "0 passed")
            [ -z "$COV_PCT" ] && COV_PCT="0"
            echo "coverage_pct=$COV_PCT" >> $GITHUB_OUTPUT
            echo "tests_passed=$TESTS" >> $GITHUB_OUTPUT
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "coverage_pct=100" >> $GITHUB_OUTPUT
            echo "tests_passed=N/A (no Python changed)" >> $GITHUB_OUTPUT
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR diff
        id: get_diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- "*.py" "*.js" "*.ts" "*.yml" "*.json" "*.sql" 2>/dev/null | head -c 12000 || git diff HEAD~1...HEAD | head -c 12000)
          echo "diff<<DIFF_EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "DIFF_EOF" >> $GITHUB_OUTPUT

      - name: Claude API - Score plan vs implementation
        id: score
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          COMPLEXITY: ${{ needs.gate1-plan-required.outputs.complexity }}
          COVERAGE: ${{ steps.coverage.outputs.coverage_pct }}
          TESTS: ${{ steps.coverage.outputs.tests_passed }}
        run: |
          echo "${{ needs.gate1-plan-required.outputs.plan_content }}" > /tmp/gate2_plan.txt
          echo "${{ steps.get_diff.outputs.diff }}" > /tmp/gate2_diff.txt
          echo "${{ needs.gate1-plan-required.outputs.changed_files }}" > /tmp/gate2_files.txt
          echo "$SCRIPT_GATE2_SCORE" | base64 -d > /tmp/gate2_score.py
          echo "$SCRIPT_DIMS_PARSE" | base64 -d > /tmp/dims_parse.py
          REVIEW_JSON=$(python3 /tmp/gate2_score.py 2>/dev/null || echo '{"verdict":"WARN","score":50,"summary":"API error","critical_issues":[],"dimensions":{"scope_match":{"score":50,"status":"WARN","finding":"Unknown"},"files_match":{"score":50,"status":"WARN","finding":"Unknown"},"approach_match":{"score":50,"status":"WARN","finding":"Unknown"},"no_scope_creep":{"score":50,"status":"WARN","finding":"Unknown"}}}')
          VERDICT=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('verdict','WARN'))" 2>/dev/null || echo "WARN")
          SCORE=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('score',0))" 2>/dev/null || echo "0")
          SUMMARY=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('summary',''))" 2>/dev/null || echo "")
          ISSUES=$(echo "$REVIEW_JSON" | python3 -c "import json,sys; print(chr(10).join(json.load(sys.stdin).get('critical_issues',[])))" 2>/dev/null || echo "")
          SCOPE=$(echo "$REVIEW_JSON" | DIM_KEY=scope_match python3 /tmp/dims_parse.py 2>/dev/null || echo "?")
          FILES_DIM=$(echo "$REVIEW_JSON" | DIM_KEY=files_match python3 /tmp/dims_parse.py 2>/dev/null || echo "?")
          APPROACH=$(echo "$REVIEW_JSON" | DIM_KEY=approach_match python3 /tmp/dims_parse.py 2>/dev/null || echo "?")
          CREEP=$(echo "$REVIEW_JSON" | DIM_KEY=no_scope_creep python3 /tmp/dims_parse.py 2>/dev/null || echo "?")
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "critical_issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "scope=$SCOPE" >> $GITHUB_OUTPUT
          echo "files_dim=$FILES_DIM" >> $GITHUB_OUTPUT
          echo "approach=$APPROACH" >> $GITHUB_OUTPUT
          echo "creep=$CREEP" >> $GITHUB_OUTPUT
          echo "review_json<<REVIEW_EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_JSON" >> $GITHUB_OUTPUT
          echo "REVIEW_EOF" >> $GITHUB_OUTPUT

      - name: Post Gate 2 result
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERDICT="${{ steps.score.outputs.verdict }}"
          SCORE="${{ steps.score.outputs.score }}"
          COVERAGE="${{ steps.coverage.outputs.coverage_pct }}"
          TESTS="${{ steps.coverage.outputs.tests_passed }}"
          SCOPE="${{ steps.score.outputs.scope }}"
          FILES_DIM="${{ steps.score.outputs.files_dim }}"
          APPROACH="${{ steps.score.outputs.approach }}"
          CREEP="${{ steps.score.outputs.creep }}"
          SUMMARY="${{ steps.score.outputs.summary }}"
          PR_NUMBER=${{ github.event.pull_request.number }}
          if [ "$COVERAGE" -ge 80 ] 2>/dev/null; then COV_ROW="PASS - ${COVERAGE}%"; else COV_ROW="FAIL - ${COVERAGE}% (need 80%)"; fi
          if [ "$VERDICT" = "PASS" ]; then LABEL="PASSED - Auto-merging"; elif [ "$VERDICT" = "WARN" ]; then LABEL="WARN - AI Architect fixing"; else LABEL="FAILED - Escalating to Ariel"; fi
          BODY=$(printf '## Gate 2 - %s (%s/100)\n\n' "$LABEL" "$SCORE")
          BODY+=$(printf '| Dimension | Result |\n|-----------|--------|\n')
          BODY+=$(printf '| Scope match | %s |\n| Files match | %s |\n| Approach match | %s |\n| No scope creep | %s |\n| Test coverage | %s |\n| Tests | %s |\n\n' "$SCOPE" "$FILES_DIM" "$APPROACH" "$CREEP" "$COV_ROW" "$TESTS")
          BODY+=$(printf '**Summary:** %s\n\n---\n*Plan Enforcement Agent v4.0 - claude-sonnet-4-5 - BidDeed.AI*' "$SUMMARY")
          gh pr comment $PR_NUMBER --body "$BODY"

  auto-merge:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: |
      needs.gate2-plan-verification.outputs.verdict == 'PASS' &&
      needs.gate2-plan-verification.outputs.coverage_pct >= '80'
    runs-on: ubuntu-latest
    name: "PASS - Auto-Merge"
    steps:
      - name: Squash merge PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCORE="${{ needs.gate2-plan-verification.outputs.score }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          RESULT=$(curl -s -X PUT -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}/merge" \
            -d "{\"merge_method\":\"squash\",\"commit_title\":\"${PR_TITLE} [Score:${SCORE}/100]\",\"commit_message\":\"Auto-merged by Plan Enforcement Agent v4.0\"}")
          MERGED=$(echo "$RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin).get('merged',False))" 2>/dev/null || echo "False")
          if [ "$MERGED" = "True" ]; then echo "Auto-merged PR #${PR_NUMBER} (${SCORE}/100)"; else echo "Merge result: $RESULT"; fi

  coverage-fix:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: |
      needs.gate2-plan-verification.outputs.verdict == 'PASS' &&
      needs.gate2-plan-verification.outputs.coverage_pct < '80'
    runs-on: ubuntu-latest
    name: "COVERAGE - Below 80%"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate test instructions
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE: ${{ needs.gate2-plan-verification.outputs.coverage_pct }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "${{ needs.gate1-plan-required.outputs.plan_content }}" > /tmp/cov_plan.txt
          git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep "\.py$" | grep -v "test_" > /tmp/cov_files.txt || true
          echo "$SCRIPT_GEN_TESTS" | base64 -d > /tmp/gen_tests.py
          FIX_JSON=$(python3 /tmp/gen_tests.py 2>/dev/null || echo '{"claude_code_instruction":"Write unit tests to reach 80% coverage.","estimated_time":"unknown"}')
          INSTRUCTION=$(echo "$FIX_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('claude_code_instruction','Write tests.'))" 2>/dev/null || echo "Write tests.")
          ETA=$(echo "$FIX_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('estimated_time','unknown'))" 2>/dev/null || echo "unknown")
          BODY=$(printf 'Coverage Gate - BLOCKED (%s%% / 80%% required)\n\nPlan compliance passed. Coverage insufficient.\n\nClaude Code: %s\n\nEst. time: %s - Push tests to re-run automatically.\n\n---\nCoverage Gate - Plan Enforcement Agent v4.0 - BidDeed.AI' "$COVERAGE" "$INSTRUCTION" "$ETA")
          gh pr comment $PR_NUMBER --body "$BODY"

  architect-fix:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: needs.gate2-plan-verification.outputs.verdict == 'WARN'
    runs-on: ubuntu-latest
    name: "WARN - AI Architect Fix"
    steps:
      - name: Post fix instructions
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          SCORE: ${{ needs.gate2-plan-verification.outputs.score }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "${{ needs.gate2-plan-verification.outputs.review_json }}" > /tmp/warn_review.txt
          echo "$SCRIPT_GEN_FIXES" | base64 -d > /tmp/gen_fixes.py
          echo "$SCRIPT_FIXES_FMT" | base64 -d > /tmp/fixes_fmt.py
          FIX_JSON=$(python3 /tmp/gen_fixes.py 2>/dev/null || echo '{"claude_code_instruction":"Fix plan deviations.","priority_fixes":[],"estimated_fix_time":"unknown","expected_score_after_fix":90}')
          INSTRUCTION=$(echo "$FIX_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('claude_code_instruction','Fix deviations.'))" 2>/dev/null || echo "Fix deviations.")
          ETA=$(echo "$FIX_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('estimated_fix_time','unknown'))" 2>/dev/null || echo "unknown")
          EXPECTED=$(echo "$FIX_JSON" | python3 -c "import json,sys; print(json.load(sys.stdin).get('expected_score_after_fix',90))" 2>/dev/null || echo "90")
          FIXES=$(echo "$FIX_JSON" | python3 /tmp/fixes_fmt.py 2>/dev/null || echo "")
          BODY=$(printf 'AI Architect - Fix Instructions (%s/100 -> %s/100)\n\nEst. fix time: %s\n\nClaude Code: %s\n\n%s\n\nPush fixes. >=90 score + >=80%% coverage = auto-merge.\n\n---\nAI Architect - Plan Enforcement Agent v4.0 - BidDeed.AI' "$SCORE" "$EXPECTED" "$ETA" "$INSTRUCTION" "$FIXES")
          gh pr comment $PR_NUMBER --body "$BODY"

  escalate-to-ariel:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: needs.gate2-plan-verification.outputs.verdict == 'FAIL'
    runs-on: ubuntu-latest
    name: "FAIL - Escalate to Ariel"
    steps:
      - name: Create escalation issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCORE="${{ needs.gate2-plan-verification.outputs.score }}"
          SUMMARY="${{ needs.gate2-plan-verification.outputs.summary }}"
          ISSUES="${{ needs.gate2-plan-verification.outputs.critical_issues }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          gh issue create \
            --title "ESCALATION: PR #${PR_NUMBER} failed (${SCORE}/100)" \
            --body "Plan Enforcement Agent FAIL Escalation. @ariel-shapira paste this URL into Claude AI chat. PR: ${PR_URL} Score: ${SCORE}/100 (min 70). Summary: ${SUMMARY}. Issues: ${ISSUES}. Options: 1) Paste URL in Claude AI chat 2) Close PR and start over 3) Comment architect-override to force merge. Escalated $(date -u '+%Y-%m-%d %H:%M UTC') - Plan Enforcement Agent v4.0" \
            --label "escalation,plan-enforcement"
          gh pr comment $PR_NUMBER --body "FAILED (${SCORE}/100) - Escalated to Ariel. GitHub Issue created. Paste the issue link into Claude AI chat. --- Plan Enforcement Agent v4.0 - BidDeed.AI"
          exit 1
