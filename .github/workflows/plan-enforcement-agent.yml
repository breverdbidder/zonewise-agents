# BidDeed.AI - Plan Enforcement Agent v4.0
# Zero-human autonomous loop with test coverage gate
#
# PLAN PR:  AI Architect reviews PLAN.md -> approves (plan-approved label) or requests changes
# CODE PR:  Gate 1 checks plan-approved label, Gate 2 runs coverage + Claude scoring
# PASS (>=90 + >=80% cov) -> auto-merge
# WARN (70-89)             -> AI Architect posts fix instructions
# COVERAGE FAIL            -> AI Architect writes test instructions
# FAIL (<70)               -> GitHub Issue -> Ariel escalation in Claude AI chat

name: Plan Enforcement Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write
  statuses: write
  issues: write

jobs:

  # ============================================================
  # JOB 1: AI Architect reviews PLAN.md (plan-only PRs)
  # ============================================================
  architect-plan-review:
    runs-on: ubuntu-latest
    name: "AI Architect - Plan Review"
    outputs:
      is_plan_only: ${{ steps.detect.outputs.is_plan_only }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect plan-only PR
        id: detect
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD 2>/dev/null || echo "")
          HAS_PLAN=$(echo "$CHANGED" | grep -qE "^PLAN\.md$" && echo "true" || echo "false")
          CODE=$(echo "$CHANGED" | grep -vE "PLAN\.md|\.md$|docs/|README|CHANGELOG|LICENSE" || true)
          HAS_CODE=$([ -n "$CODE" ] && echo "true" || echo "false")
          if [ "$HAS_PLAN" = "true" ] && [ "$HAS_CODE" = "false" ]; then
            echo "is_plan_only=true" >> $GITHUB_OUTPUT
          else
            echo "is_plan_only=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Architect evaluate PLAN.md
        if: steps.detect.outputs.is_plan_only == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PLAN=$(cat PLAN.md 2>/dev/null | head -c 8000 || echo "missing")

          cat << 'PYEOF' > /tmp/review_plan.py
          import json, os, urllib.request, sys
          api_key = os.environ["ANTHROPIC_API_KEY"]
          plan = open("/tmp/plan_input.txt").read()
          pr_title = os.environ.get("PR_TITLE", "")
          schema = '{"verdict":"APPROVED","score":90,"sections_status":{"objective":"PASS","files_changed":"PASS","approach":"PASS","risks":"PASS","not_doing":"PASS","complexity":"PASS"},"issues":[],"improvements":[],"architect_note":"2 sentences","cleared_for_implementation":true}'
          prompt = (
              "You are the AI Architect for BidDeed.AI (foreclosure auction AI platform).\n"
              "Review this PLAN.md. Evaluate: Objective, Files Changed, Approach, Risks, NOT Doing, Estimated Complexity.\n"
              "Flag scope too broad, conflicts with LangGraph/Supabase/GitHub Actions, missing domain considerations.\n"
              "PR: " + pr_title + "\nPLAN:\n" + plan + "\n"
              "Score 85+ = APPROVED. Below 85 = CHANGES_REQUESTED.\n"
              "Respond ONLY with valid JSON: " + schema
          )
          payload = json.dumps({"model": "claude-sonnet-4-5", "max_tokens": 1500, "messages": [{"role": "user", "content": prompt}]}).encode()
          req = urllib.request.Request("https://api.anthropic.com/v1/messages", data=payload)
          req.add_header("Content-Type", "application/json")
          req.add_header("x-api-key", api_key)
          req.add_header("anthropic-version", "2023-06-01")
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)
          text = data["content"][0]["text"].strip()
          if text.startswith("```"):
              text = text.split("```")[1]
              if text.startswith("json"): text = text[4:]
          d = json.loads(text.strip())
          print(json.dumps(d))
          PYEOF

          echo "$PLAN" > /tmp/plan_input.txt
          REVIEW=$(PR_TITLE="$PR_TITLE" python3 /tmp/review_plan.py 2>/dev/null || echo '{"verdict":"CHANGES_REQUESTED","score":0,"architect_note":"Parse error - resubmit plan.","cleared_for_implementation":false,"sections_status":{},"issues":["Could not parse response"],"improvements":[]}')

          VERDICT=$(echo "$REVIEW" | python3 -c "import json,sys; print(json.load(sys.stdin).get('verdict','CHANGES_REQUESTED'))" 2>/dev/null || echo "CHANGES_REQUESTED")
          SCORE=$(echo "$REVIEW" | python3 -c "import json,sys; print(json.load(sys.stdin).get('score',0))" 2>/dev/null || echo "0")
          NOTE=$(echo "$REVIEW" | python3 -c "import json,sys; print(json.load(sys.stdin).get('architect_note',''))" 2>/dev/null || echo "")

          SECTIONS=$(echo "$REVIEW" | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          s=d.get('sections_status',{})
          labels={'objective':'Objective','files_changed':'Files Changed','approach':'Approach','risks':'Risks','not_doing':'NOT Doing','complexity':'Complexity'}
          out=''
          for k,label in labels.items():
              st=s.get(k,'?')
              e='OK' if st=='PASS' else 'FAIL'
              out+=f'| {label} | {e} |\n'
          print(out)
          " 2>/dev/null || echo "")

          ISSUES=$(echo "$REVIEW" | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          out=''
          for i in d.get('issues',[]): out+=f'- {i}\n'
          for i in d.get('improvements',[]): out+=f'- {i}\n'
          print(out)
          " 2>/dev/null || echo "")

          if [ "$VERDICT" = "APPROVED" ]; then
            gh pr edit "$PR_NUMBER" --add-label "plan-approved" 2>/dev/null || true
            gh pr comment "$PR_NUMBER" --body "## AI Architect - PLAN APPROVED (${SCORE}/100)

          | Section | Status |
          |---------|--------|
          ${SECTIONS}

          **Architect note:** ${NOTE}

          ### Claude Code - Cleared to implement
          Open a new PR with your implementation. Gate 2 will verify code matches this plan.

          ---
          *AI Architect (claude-sonnet-4-5) - Plan Enforcement Agent v4.0 - BidDeed.AI*"
          else
            gh pr comment "$PR_NUMBER" --body "## AI Architect - CHANGES REQUESTED (${SCORE}/100)

          | Section | Status |
          |---------|--------|
          ${SECTIONS}

          **Architect note:** ${NOTE}

          **Issues to fix:**
          ${ISSUES}

          Push an updated PLAN.md - AI Architect will re-review automatically.

          ---
          *AI Architect (claude-sonnet-4-5) - Plan Enforcement Agent v4.0 - BidDeed.AI*"
          fi

  # ============================================================
  # JOB 2: Gate 1 - Require architect-approved plan
  # ============================================================
  gate1-plan-required:
    needs: architect-plan-review
    if: needs.architect-plan-review.outputs.is_plan_only == 'false'
    runs-on: ubuntu-latest
    name: "Gate 1 - Architect-Approved Plan Required"
    outputs:
      has_plan: ${{ steps.detect.outputs.has_plan }}
      has_code: ${{ steps.detect.outputs.has_code }}
      plan_approved: ${{ steps.detect.outputs.plan_approved }}
      plan_content: ${{ steps.detect.outputs.plan_content }}
      complexity: ${{ steps.detect.outputs.complexity }}
      changed_files: ${{ steps.detect.outputs.changed_files }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for approved plan
        id: detect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || git diff --name-only HEAD~1...HEAD 2>/dev/null || echo "")

          if [ -f "PLAN.md" ]; then
            PLAN=$(cat PLAN.md | head -c 8000)
            COMPLEXITY=$(echo "$PLAN" | grep -iE "complexity\s*[:\-]\s*(Low|Medium|High)" | grep -oiE "Low|Medium|High" | head -1 || echo "Medium")
            echo "has_plan=true" >> $GITHUB_OUTPUT
            echo "complexity=$COMPLEXITY" >> $GITHUB_OUTPUT
            printf '%s' "$PLAN" > /tmp/plan_for_gate1.txt
            PLAN_B64=$(base64 -w 0 /tmp/plan_for_gate1.txt)
            echo "plan_content=$PLAN_B64" >> $GITHUB_OUTPUT
          else
            echo "has_plan=false" >> $GITHUB_OUTPUT
            echo "complexity=Medium" >> $GITHUB_OUTPUT
            echo "plan_content=" >> $GITHUB_OUTPUT
          fi

          LABELS=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels" \
            | python3 -c "import json,sys; print(' '.join(l['name'] for l in json.load(sys.stdin)))" 2>/dev/null || echo "")

          OPEN_APPROVED=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&per_page=20" \
            | python3 -c "
          import json,sys
          prs=json.load(sys.stdin)
          found=any('plan-approved' in [l['name'] for l in pr.get('labels',[])] for pr in prs)
          print('true' if found else 'false')
          " 2>/dev/null || echo "false")

          if echo "$LABELS" | grep -q "plan-approved" || [ "$OPEN_APPROVED" = "true" ]; then
            echo "plan_approved=true" >> $GITHUB_OUTPUT
          else
            echo "plan_approved=false" >> $GITHUB_OUTPUT
          fi

          CODE=$(echo "$CHANGED" | grep -vE "PLAN\.md|\.md$|docs/|README|CHANGELOG|LICENSE" || true)
          if [ -n "$CODE" ]; then
            echo "has_code=true" >> $GITHUB_OUTPUT
            echo "changed_files<<FILESEOF" >> $GITHUB_OUTPUT
            echo "$CODE" | head -20 >> $GITHUB_OUTPUT
            echo "FILESEOF" >> $GITHUB_OUTPUT
          else
            echo "has_code=false" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
          fi

      - name: BLOCKED - No approved plan
        if: steps.detect.outputs.has_code == 'true' && steps.detect.outputs.plan_approved == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" --body "## BLOCKED - No Architect-Approved Plan

          No \`plan-approved\` label found. Open a plan-only PR first.

          **Valid PLAN.md requires:** Objective, Files Changed, Approach, Risks, NOT Doing, Estimated Complexity.

          ---
          *Plan Enforcement Agent v4.0 - BidDeed.AI*"
          echo "::error::BLOCKED: No architect-approved plan."
          exit 1

  # ============================================================
  # JOB 3: Gate 2 - Coverage + Claude scoring
  # ============================================================
  gate2-plan-verification:
    needs: gate1-plan-required
    if: needs.gate1-plan-required.outputs.has_plan == 'true' && needs.gate1-plan-required.outputs.has_code == 'true'
    runs-on: ubuntu-latest
    name: "Gate 2 - Coverage + Plan Verification"
    outputs:
      verdict: ${{ steps.score.outputs.verdict }}
      score: ${{ steps.score.outputs.score }}
      review_json: ${{ steps.score.outputs.review_json }}
      summary: ${{ steps.score.outputs.summary }}
      critical_issues: ${{ steps.score.outputs.critical_issues }}
      coverage_pct: ${{ steps.coverage.outputs.coverage_pct }}
      tests_result: ${{ steps.coverage.outputs.tests_result }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run test coverage
        id: coverage
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep "\.py$" | grep -v "test_" || echo "")

          if [ -n "$CHANGED" ]; then
            pip install pytest pytest-cov --quiet 2>/dev/null || true
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt --quiet 2>/dev/null || true
            fi
            COV=$(python3 -m pytest tests/ --cov=src --cov-report=term-missing --tb=no -q 2>&1 | tail -20 || echo "coverage_error")
            PCT=$(echo "$COV" | grep -oE "TOTAL[[:space:]]+[0-9]+[[:space:]]+[0-9]+[[:space:]]+([0-9]+)%" | grep -oE "[0-9]+%" | tail -1 | tr -d "%" || echo "0")
            PASSED=$(echo "$COV" | grep -oE "[0-9]+ passed" | head -1 || echo "0 passed")
            FAILED=$(echo "$COV" | grep -oE "[0-9]+ failed" | head -1 || echo "")
            if [ -z "$PCT" ]; then PCT="0"; fi
            echo "coverage_pct=$PCT" >> $GITHUB_OUTPUT
            echo "tests_result=$PASSED $FAILED" >> $GITHUB_OUTPUT
            echo "has_python=true" >> $GITHUB_OUTPUT
          else
            echo "coverage_pct=100" >> $GITHUB_OUTPUT
            echo "tests_result=no python changes" >> $GITHUB_OUTPUT
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.py' '*.js' '*.ts' '*.yml' '*.json' '*.sql' 2>/dev/null | head -c 12000 || echo "")
          printf '%s' "$DIFF" > /tmp/pr_diff.txt

      - name: Claude API - Score plan vs implementation
        id: score
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PLAN_B64="${{ needs.gate1-plan-required.outputs.plan_content }}"
          PLAN=$(echo "$PLAN_B64" | base64 -d 2>/dev/null || echo "plan unavailable")
          COVERAGE="${{ steps.coverage.outputs.coverage_pct }}"
          TESTS="${{ steps.coverage.outputs.tests_result }}"
          FILES="${{ needs.gate1-plan-required.outputs.changed_files }}"
          COMPLEXITY="${{ needs.gate1-plan-required.outputs.complexity }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          DIFF=$(cat /tmp/pr_diff.txt | head -c 10000)

          printf '%s' "$PLAN" > /tmp/g2_plan.txt
          printf '%s' "$DIFF" > /tmp/g2_diff.txt
          printf '%s' "$FILES" > /tmp/g2_files.txt

          cat << 'PYEOF' > /tmp/gate2_score.py
          import json, os, urllib.request
          api_key = os.environ["ANTHROPIC_API_KEY"]
          plan = open("/tmp/g2_plan.txt").read()
          diff = open("/tmp/g2_diff.txt").read()
          files = open("/tmp/g2_files.txt").read()
          pr_title = os.environ.get("PR_TITLE", "")
          complexity = os.environ.get("COMPLEXITY", "Medium")
          coverage = os.environ.get("COVERAGE", "0")
          tests = os.environ.get("TESTS", "")
          schema = '{"verdict":"PASS","score":95,"dimensions":{"scope_match":{"score":95,"status":"PASS","finding":"one sentence"},"files_match":{"score":95,"status":"PASS","finding":"one sentence"},"approach_match":{"score":95,"status":"PASS","finding":"one sentence"},"no_scope_creep":{"score":95,"status":"PASS","finding":"one sentence"}},"critical_issues":[],"warnings":[],"fix_instructions":[],"summary":"2-3 sentences","ariel_action":"APPROVE"}'
          prompt = (
              "You are the Plan Enforcement Agent for BidDeed.AI.\n"
              "Verify implementation matches the approved PLAN.md.\n"
              "PR: " + pr_title + " | Complexity: " + complexity + "\n"
              "Coverage: " + coverage + "% (min 80%) | Tests: " + tests + "\n"
              "PLAN:\n" + plan + "\n\nChanged Files:\n" + files + "\n\nDiff:\n" + diff + "\n"
              "IMPORTANT: Penalize score if coverage<80. Flag Python files without tests as critical issue.\n"
              "PASS>=90 AND coverage>=80. WARN=70-89. FAIL<70.\n"
              "Respond ONLY with valid JSON: " + schema
          )
          payload = json.dumps({"model": "claude-sonnet-4-5", "max_tokens": 2000, "messages": [{"role": "user", "content": prompt}]}).encode()
          req = urllib.request.Request("https://api.anthropic.com/v1/messages", data=payload)
          req.add_header("Content-Type", "application/json")
          req.add_header("x-api-key", api_key)
          req.add_header("anthropic-version", "2023-06-01")
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)
          text = data["content"][0]["text"].strip()
          if text.startswith("```"):
              text = text.split("```")[1]
              if text.startswith("json"): text = text[4:]
          print(text.strip())
          PYEOF

          REVIEW=$(PR_TITLE="$PR_TITLE" COMPLEXITY="$COMPLEXITY" COVERAGE="$COVERAGE" TESTS="$TESTS" \
            python3 /tmp/gate2_score.py 2>/dev/null || \
            echo '{"verdict":"WARN","score":50,"summary":"Scoring error - manual review needed","critical_issues":[],"dimensions":{}}')

          VERDICT=$(echo "$REVIEW" | python3 -c "import json,sys; print(json.load(sys.stdin).get('verdict','WARN'))" 2>/dev/null || echo "WARN")
          SCORE=$(echo "$REVIEW" | python3 -c "import json,sys; print(json.load(sys.stdin).get('score',0))" 2>/dev/null || echo "0")
          SUMMARY=$(echo "$REVIEW" | python3 -c "import json,sys; print(json.load(sys.stdin).get('summary',''))" 2>/dev/null || echo "")
          ISSUES=$(echo "$REVIEW" | python3 -c "import json,sys; print('; '.join(json.load(sys.stdin).get('critical_issues',[])))" 2>/dev/null || echo "")

          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "critical_issues=$ISSUES" >> $GITHUB_OUTPUT
          printf '%s' "$REVIEW" > /tmp/review_output.json
          REVIEW_B64=$(base64 -w 0 /tmp/review_output.json)
          echo "review_json=$REVIEW_B64" >> $GITHUB_OUTPUT

      - name: Post Gate 2 result comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          VERDICT="${{ steps.score.outputs.verdict }}"
          SCORE="${{ steps.score.outputs.score }}"
          COVERAGE="${{ steps.coverage.outputs.coverage_pct }}"
          TESTS="${{ steps.coverage.outputs.tests_result }}"
          SUMMARY="${{ steps.score.outputs.summary }}"
          REVIEW_B64="${{ steps.score.outputs.review_json }}"

          REVIEW=$(echo "$REVIEW_B64" | base64 -d 2>/dev/null || echo "{}")

          get_dim() {
            echo "$REVIEW" | python3 -c "
          import json,sys,os
          key=os.environ.get('K','')
          d=json.loads(sys.stdin.read())
          s=d.get('dimensions',{}).get(key,{})
          print(s.get('status','?')+' - '+s.get('finding',''))
          " K="$1" 2>/dev/null || echo "?"
          }

          SCOPE=$(get_dim scope_match)
          FILES_DIM=$(get_dim files_match)
          APPROACH=$(get_dim approach_match)
          CREEP=$(get_dim no_scope_creep)

          if [ "$COVERAGE" -ge 80 ] 2>/dev/null; then
            COV_ROW="PASS - ${COVERAGE}%"
          else
            COV_ROW="FAIL - ${COVERAGE}% (min: 80%)"
          fi

          if [ "$VERDICT" = "PASS" ]; then LABEL="PASS - Auto-merging"
          elif [ "$VERDICT" = "WARN" ]; then LABEL="WARN - Fixes needed"
          else LABEL="FAIL - Escalating"; fi

          gh pr comment "$PR_NUMBER" --body "## Gate 2 - ${LABEL} (${SCORE}/100)

          | Dimension | Result |
          |-----------|--------|
          | Scope match | ${SCOPE} |
          | Files match | ${FILES_DIM} |
          | Approach match | ${APPROACH} |
          | No scope creep | ${CREEP} |
          | Test coverage | ${COV_ROW} |
          | Tests | ${TESTS} |

          **Summary:** ${SUMMARY}

          ---
          *Plan Enforcement Agent v4.0 - claude-sonnet-4-5 - BidDeed.AI*"

  # ============================================================
  # PASS: Auto-merge (score >=90 AND coverage >=80)
  # ============================================================
  auto-merge:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: |
      needs.gate2-plan-verification.outputs.verdict == 'PASS' &&
      needs.gate2-plan-verification.outputs.coverage_pct >= '80'
    runs-on: ubuntu-latest
    name: "PASS - Auto-Merge"

    steps:
      - name: Squash merge PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCORE="${{ needs.gate2-plan-verification.outputs.score }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          curl -s -X PUT \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}/merge" \
            -d "{\"merge_method\":\"squash\",\"commit_title\":\"${PR_TITLE} [Plan Score: ${SCORE}/100]\",\"commit_message\":\"Auto-merged by Plan Enforcement Agent v4.0. Score: ${SCORE}/100.\"}"

  # ============================================================
  # WARN: AI Architect posts fix instructions
  # ============================================================
  architect-fix:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: needs.gate2-plan-verification.outputs.verdict == 'WARN'
    runs-on: ubuntu-latest
    name: "WARN - AI Architect Fix Instructions"

    steps:
      - name: Generate fix instructions
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCORE="${{ needs.gate2-plan-verification.outputs.score }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          REVIEW_B64="${{ needs.gate2-plan-verification.outputs.review_json }}"
          REVIEW=$(echo "$REVIEW_B64" | base64 -d 2>/dev/null || echo "{}")

          printf '%s' "$REVIEW" > /tmp/warn_review.txt

          cat << 'PYEOF' > /tmp/gen_fixes.py
          import json, os, urllib.request
          api_key = os.environ["ANTHROPIC_API_KEY"]
          review = open("/tmp/warn_review.txt").read()
          pr_title = os.environ.get("PR_TITLE", "")
          score = os.environ.get("SCORE", "0")
          schema = '{"priority_fixes":[{"issue":"what","file":"path.py","fix":"exactly what","urgency":"HIGH"}],"claude_code_instruction":"Execute the following fixes...","estimated_fix_time":"X min","expected_score_after_fix":92}'
          prompt = (
              "AI Architect for BidDeed.AI. Gate 2 WARN (" + score + "/100) for: " + pr_title + "\n"
              "Review: " + review + "\n"
              "Write precise fix instructions for Claude Code. Specific files and actions only.\n"
              "Respond ONLY with valid JSON: " + schema
          )
          payload = json.dumps({"model": "claude-sonnet-4-5", "max_tokens": 1500, "messages": [{"role": "user", "content": prompt}]}).encode()
          req = urllib.request.Request("https://api.anthropic.com/v1/messages", data=payload)
          req.add_header("Content-Type", "application/json")
          req.add_header("x-api-key", api_key)
          req.add_header("anthropic-version", "2023-06-01")
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)
          text = data["content"][0]["text"].strip()
          if text.startswith("```"):
              text = text.split("```")[1]
              if text.startswith("json"): text = text[4:]
          print(text.strip())
          PYEOF

          FIXES=$(PR_TITLE="$PR_TITLE" SCORE="$SCORE" python3 /tmp/gen_fixes.py 2>/dev/null || \
            echo '{"claude_code_instruction":"Fix plan deviations.","priority_fixes":[],"estimated_fix_time":"unknown","expected_score_after_fix":90}')

          INSTRUCTION=$(echo "$FIXES" | python3 -c "import json,sys; print(json.load(sys.stdin).get('claude_code_instruction','Fix deviations.'))" 2>/dev/null || echo "Fix deviations.")
          ETA=$(echo "$FIXES" | python3 -c "import json,sys; print(json.load(sys.stdin).get('estimated_fix_time','unknown'))" 2>/dev/null || echo "unknown")
          EXPECTED=$(echo "$FIXES" | python3 -c "import json,sys; print(json.load(sys.stdin).get('expected_score_after_fix',90))" 2>/dev/null || echo "90")

          FIX_LIST=$(echo "$FIXES" | python3 -c "
          import json,sys
          d=json.load(sys.stdin)
          out=''
          for i,f in enumerate(d.get('priority_fixes',[]),1):
              out+=f'Fix {i} [{f.get(\"urgency\",\"MEDIUM\")}]: {f.get(\"issue\",\"\")} | {f.get(\"file\",\"\")} | {f.get(\"fix\",\"\")}\n'
          print(out)
          " 2>/dev/null || echo "")

          gh pr comment "$PR_NUMBER" --body "## AI Architect - Fix Instructions for Claude Code

          **Score:** ${SCORE}/100 -> **Target:** ${EXPECTED}/100 | **Est. time:** ${ETA}

          ${INSTRUCTION}

          ${FIX_LIST}

          Push fixes to this branch - Gate 2 re-runs automatically. Score >=90 -> auto-merged.

          ---
          *AI Architect (claude-sonnet-4-5) - Plan Enforcement Agent v4.0 - BidDeed.AI*"

  # ============================================================
  # COVERAGE FAIL: Plan passed but coverage < 80%
  # ============================================================
  coverage-fix:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: |
      needs.gate2-plan-verification.outputs.verdict == 'PASS' &&
      needs.gate2-plan-verification.outputs.coverage_pct < '80'
    runs-on: ubuntu-latest
    name: "COVERAGE FAIL - Write Tests"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate test instructions
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COVERAGE="${{ needs.gate2-plan-verification.outputs.coverage_pct }}"
          PLAN_B64="${{ needs.gate1-plan-required.outputs.plan_content }}"
          PLAN=$(echo "$PLAN_B64" | base64 -d 2>/dev/null || echo "")
          CHANGED_PY=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep "\.py$" | grep -v "test_" || echo "")

          printf '%s' "$PLAN" > /tmp/cov_plan.txt
          printf '%s' "$CHANGED_PY" > /tmp/cov_files.txt

          cat << 'PYEOF' > /tmp/gen_tests.py
          import json, os, urllib.request
          api_key = os.environ["ANTHROPIC_API_KEY"]
          plan = open("/tmp/cov_plan.txt").read()
          files = open("/tmp/cov_files.txt").read()
          coverage = os.environ.get("COVERAGE", "0")
          schema = '{"files_needing_tests":["file.py"],"test_instructions":[{"file":"tests/test_X.py","tests_to_write":["test names"],"priority":"HIGH"}],"claude_code_instruction":"Execute the following to reach 80% coverage...","estimated_time":"X minutes"}'
          prompt = (
              "Coverage is " + coverage + "% (minimum 80%). Write test instructions for Claude Code.\n"
              "Files needing tests: " + files + "\nPlan: " + plan + "\n"
              "Respond ONLY with valid JSON: " + schema
          )
          payload = json.dumps({"model": "claude-sonnet-4-5", "max_tokens": 1500, "messages": [{"role": "user", "content": prompt}]}).encode()
          req = urllib.request.Request("https://api.anthropic.com/v1/messages", data=payload)
          req.add_header("Content-Type", "application/json")
          req.add_header("x-api-key", api_key)
          req.add_header("anthropic-version", "2023-06-01")
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)
          text = data["content"][0]["text"].strip()
          if text.startswith("```"):
              text = text.split("```")[1]
              if text.startswith("json"): text = text[4:]
          print(text.strip())
          PYEOF

          RESULT=$(COVERAGE="$COVERAGE" python3 /tmp/gen_tests.py 2>/dev/null || \
            echo '{"claude_code_instruction":"Write tests to reach 80% coverage.","estimated_time":"unknown"}')

          INSTRUCTION=$(echo "$RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin).get('claude_code_instruction','Write tests to reach 80% coverage.'))" 2>/dev/null || echo "Write tests.")
          ETA=$(echo "$RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin).get('estimated_time','unknown'))" 2>/dev/null || echo "unknown")

          gh pr comment "$PR_NUMBER" --body "## Coverage Gate - BLOCKED (${COVERAGE}% / 80% required)

          Plan compliance passed but coverage is insufficient.

          ${INSTRUCTION}

          **Est. time:** ${ETA}

          Push tests to this branch - re-runs automatically. >=80% + score >=90 -> auto-merged.

          ---
          *AI Architect (claude-sonnet-4-5) - Coverage Gate - Plan Enforcement Agent v4.0 - BidDeed.AI*"

  # ============================================================
  # FAIL: Escalate to Ariel
  # ============================================================
  escalate-to-ariel:
    needs: [gate1-plan-required, gate2-plan-verification]
    if: needs.gate2-plan-verification.outputs.verdict == 'FAIL'
    runs-on: ubuntu-latest
    name: "FAIL - Escalate to Ariel"

    steps:
      - name: Create escalation issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SCORE="${{ needs.gate2-plan-verification.outputs.score }}"
          SUMMARY="${{ needs.gate2-plan-verification.outputs.summary }}"
          ISSUES="${{ needs.gate2-plan-verification.outputs.critical_issues }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          gh issue create \
            --title "ESCALATION: PR #${PR_NUMBER} failed plan verification (${SCORE}/100)" \
            --body "## Plan Enforcement Agent - FAIL Escalation

          Paste this issue URL into Claude AI chat for AI Architect recommendation.

          **PR:** [#${PR_NUMBER} - ${PR_TITLE}](${PR_URL})
          **Score:** ${SCORE}/100 (minimum: 70)
          **Summary:** ${SUMMARY}
          **Critical Issues:** ${ISSUES}

          **Options:**
          1. Paste URL into Claude AI chat - AI Architect recommends path forward
          2. Close PR - start over with new plan
          3. Comment 'architect-override' on PR if you accept the risk

          ---
          *Plan Enforcement Agent v4.0 - BidDeed.AI*" \
            --label "escalation,plan-enforcement"

          gh pr comment "$PR_NUMBER" --body "## Gate 2 - FAILED (${SCORE}/100)

          Below 70 threshold. GitHub Issue created - check issues tab.
          Paste issue link into Claude AI chat for next steps.

          ---
          *Plan Enforcement Agent v4.0 - BidDeed.AI*"
          exit 1
